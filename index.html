<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>血糖換算工具</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">
<link rel="icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  :root { --radius: 14px; }
  body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"Noto Sans CJK TC","PingFang TC","Helvetica Neue",Arial,sans-serif;
         margin: 0; background: #f7fbff; color:#0a2540; }
  header { padding: 18px 16px; text-align:center; font-weight:700; background: #e8f2ff; }
  .wrap { max-width: 560px; margin: 0 auto; padding: 16px; }
  .card { background: #fff; border-radius: var(--radius); box-shadow: 0 6px 24px rgba(10,37,64,.08);
          padding: 16px; margin-bottom: 14px; }
  .row { display:flex; gap:12px; align-items:center; }
  .col { flex:1; }
  label { display:block; font-size:14px; margin-bottom:8px; }
  input[type="number"] { width: 100%; font-size: 20px; padding: 12px 14px; border-radius: 12px; border:1px solid #c5d9ee; outline: none; }
  input[type="number"]:focus { border-color:#3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.15); }
  .unit { font-size: 13px; color:#3b6ea5; margin-top:6px; }
  .btns { display:flex; gap:10px; margin-top: 10px; }
  button { flex:1; padding: 12px 14px; border:none; border-radius: 12px; font-weight:600; cursor:pointer; }
  .primary { background:#2563eb; color:#fff; }
  .ghost { background:#eef5ff; color:#0a2540; }
  .hint { font-size:13px; color:#315d8a; margin: 8px 0 0; }
  .badge { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px; }
  .ok { background:#e6f7ec; color:#0f6b34; }
  .warn { background:#fff7e6; color:#8a5a00; }
  .danger { background:#fde7e7; color:#a31212; }
  .fieldset { display:flex; gap:14px; flex-wrap:wrap; font-size:13px; color:#315d8a; margin: 6px 0 0; }
  footer { text-align:center; color:#5b7da6; font-size:12px; padding: 16px; }
</style>
</head>
<body>
<header>血糖換算＋HbA1c 估算＋即時範圍提示</header>
<div class="wrap">

  <!-- Converter -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label for="mg">輸入 mg/dL：</label>
        <input id="mg" type="number" inputmode="decimal" placeholder="例如 126" step="0.1">
        <div class="unit">自動換算為 mmol/L（÷18）</div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="col">
        <label for="mmol">輸入 mmol/L：</label>
        <input id="mmol" type="number" inputmode="decimal" placeholder="例如 7.0" step="0.1">
        <div class="unit">自動換算為 mg/dL（×18）</div>
      </div>
    </div>
    <div class="btns">
      <button class="primary" id="copyBtn">複製結果</button>
      <button class="ghost" id="clearBtn">清除</button>
    </div>
    <p class="hint">公式：mmol/L = mg/dL ÷ 18；mg/dL = mmol/L × 18</p>
  </div>

  <!-- Quick ref -->
  <div class="card">
    <label>常見對照：</label>
    <div class="row">
      <div class="col">
        <div class="unit">90 mg/dL ≈ 5.0 mmol/L</div>
        <div class="unit">100 mg/dL ≈ 5.6 mmol/L</div>
        <div class="unit">110 mg/dL ≈ 6.1 mmol/L</div>
        <div class="unit">126 mg/dL ≈ 7.0 mmol/L</div>
        <div class="unit">140 mg/dL ≈ 7.8 mmol/L</div>
      </div>
    </div>
  </div>

  <!-- HbA1c estimator -->
  <div class="card">
    <label for="avgInput">估算 HbA1c（依 ADAG 公式）</label>
    <div class="row">
      <div class="col">
        <input id="avgInput" type="number" inputmode="decimal" placeholder="輸入平均血糖值，例如 120 或 6.7" step="0.1">
        <div class="fieldset">
          <label><input type="radio" name="unit" value="mg" checked> mg/dL</label>
          <label><input type="radio" name="unit" value="mmol"> mmol/L</label>
          <span class="unit">ADAG：HbA1c(%) ≈ (平均 mg/dL + 46.7) / 28.7；或 ≈ (平均 mmol/L + 2.59) / 1.59</span>
        </div>
        <div id="a1cOut" class="unit"><span class="badge ok">HbA1c：—</span></div>
        <div id="avgEcho" class="unit">平均血糖回推：—</div>
      </div>
    </div>
  </div>

  <!-- Range tips -->
  <div class="card">
    <label>即時血糖範圍提示</label>
    <div class="fieldset">
      <label><input type="radio" name="ctx" value="fasting" checked> 空腹（FPG）</label>
      <label><input type="radio" name="ctx" value="post"> 飯後 1–2 小時（PPG）</label>
    </div>
    <div class="unit" id="tipRange">空腹建議：80–130 mg/dL（4.4–7.2 mmol/L）</div>
    <div class="result" id="tipStatus" style="margin-top:8px;"><span class="badge warn">—</span></div>
    <div class="unit">說明：此為成人非孕者的一般目標，實際目標請依醫療專業個別化調整。</div>
  </div>

</div>
<footer>提示：加入主畫面後，可離線使用；結果僅供參考，不取代醫療判讀。</footer>
<script>
// elements
const mg = document.getElementById('mg');
const mmol = document.getElementById('mmol');
const copyBtn = document.getElementById('copyBtn');
const clearBtn = document.getElementById('clearBtn');
const avgInput = document.getElementById('avgInput');
const unitRadios = document.getElementsByName('unit');
const a1cOut = document.getElementById('a1cOut');
const avgEcho = document.getElementById('avgEcho');
const tipRange = document.getElementById('tipRange');
const tipStatus = document.getElementById('tipStatus');
const ctxRadios = document.getElementsByName('ctx');

let updating = false;

function round(val, digits=2) {
  if (val === '' || isNaN(val)) return '';
  const f = Math.pow(10, digits);
  return Math.round(val * f) / f;
}

// bidirectional converter
mg.addEventListener('input', () => {
  if (updating) return;
  updating = true;
  const v = parseFloat(mg.value);
  mmol.value = isNaN(v) ? '' : round(v/18, 2);
  updating = false;
  updateTips();
});

mmol.addEventListener('input', () => {
  if (updating) return;
  updating = true;
  const v = parseFloat(mmol.value);
  mg.value = isNaN(v) ? '' : round(v*18, 0);
  updating = false;
  updateTips();
});

copyBtn.addEventListener('click', async () => {
  const txt = `mg/dL: ${mg.value || '-'}\nmmol/L: ${mmol.value || '-'}`;
  try {
    await navigator.clipboard.writeText(txt);
    copyBtn.textContent = "已複製";
    setTimeout(()=> copyBtn.textContent="複製結果", 1200);
  } catch(e) {
    alert("無法複製，請手動長按選取。");
  }
});

clearBtn.addEventListener('click', () => {
  mg.value = '';
  mmol.value = '';
  updateTips();
});

// HbA1c estimator
function getSelectedUnit() {
  for (const r of unitRadios) if (r.checked) return r.value;
  return 'mg';
}

function calcA1c() {
  const unit = getSelectedUnit();
  const v = parseFloat(avgInput.value);
  if (isNaN(v)) {
    a1cOut.innerHTML = '<span class="badge ok">HbA1c：—</span>';
    avgEcho.textContent = "平均血糖回推：—";
    return;
  }
  let a1c, avgmg, avgmmol;
  if (unit === 'mg') {
    avgmg = v;
    avgmmol = v/18;
    a1c = (v + 46.7) / 28.7; // ADAG
  } else {
    avgmmol = v;
    avgmg = v*18;
    a1c = (v + 2.59) / 1.59; // Correct ADAG rearrangement
  }
  a1cOut.innerHTML = '<span class="badge ok">HbA1c：' + round(a1c, 2) + ' %</span>';
  avgEcho.textContent = "平均血糖（mg/dL：" + round(avgmg,0) + "；mmol/L：" + round(avgmmol,2) + "）";
}

avgInput.addEventListener('input', calcA1c);
for (const r of unitRadios) r.addEventListener('change', calcA1c);

// Range tips
function getCtx() {
  for (const r of ctxRadios) if (r.checked) return r.value;
  return 'fasting';
}

function updateTips() {
  const ctx = getCtx();
  const v = parseFloat(mg.value);
  if (ctx === 'fasting') {
    tipRange.textContent = "空腹建議：80–130 mg/dL（4.4–7.2 mmol/L）";
    if (isNaN(v)) {
      tipStatus.innerHTML = '<span class="badge warn">—</span>';
      return;
    }
    if (v < 70) {
      tipStatus.innerHTML = '<span class="badge danger">⬇️ 低血糖（<70）</span>';
    } else if (v >= 80 && v <= 130) {
      tipStatus.innerHTML = '<span class="badge ok">✅ 在空腹建議範圍內</span>';
    } else if (v < 80) {
      tipStatus.innerHTML = '<span class="badge warn">偏低（80 以下）</span>';
    } else {
      tipStatus.innerHTML = '<span class="badge warn">偏高（>130）</span>';
    }
  } else {
    tipRange.textContent = "飯後 1–2 小時建議：< 180 mg/dL（< 10.0 mmol/L）";
    if (isNaN(v)) {
      tipStatus.innerHTML = '<span class="badge warn">—</span>';
      return;
    }
    if (v < 70) {
      tipStatus.innerHTML = '<span class="badge danger">⬇️ 低血糖（<70）</span>';
    } else if (v < 180) {
      tipStatus.innerHTML = '<span class="badge ok">✅ 在飯後建議範圍內</span>';
    } else {
      tipStatus.innerHTML = '<span class="badge warn">偏高（≥180）</span>';
    }
  }
}

for (const r of ctxRadios) r.addEventListener('change', updateTips);

// Init
updateTips();

// PWA SW
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
